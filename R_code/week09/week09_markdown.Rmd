---
title: "Environmental Filtering and Null Models"
output: html_document
---

We are going to calculate "functional richness" (the range or convex hull volume of trait values) in some grassland communities and compare them to null expectations based on random sampling of species from the regional pool.  We will use these to estimate the intensity of environmental filtering.

First let's read in our community composition and functional trait datasets

```{r}
setwd('U:/LOCKED/grassland_data/')
commDat=as.data.frame(read.csv('community_comp.csv',head=T,row.names=1))
traitDat=as.data.frame(read.csv('trait_by_species.csv',head=T,row.names=1))
traitDat=traitDat[,-c(1,19:20)]
```

Let's start with a single trait, height, and calculate the range of height values across the 49 communities in our dataset

```{r}
#this is a function to calculate range; this is the equivalent of running dbFD() from the FD library on a single trait, but the function below provides you with a pretty generic structure for calculating trait indices for communities; one would just change the calculation within "return()"
rnge=function(comm,trait){
  present=names(comm)[comm!=0]
  traitVal=trait[match(present,names(trait))]
  return(max(traitVal)-min(traitVal))
}
Height=traitDat$Ht
names(Height)=rownames(traitDat)
HeightRnge=apply(commDat,1,rnge,Height)
hist(HeightRnge)
```

We can see that the range of height varies from 0.004 to 0.016 g.  Now we need to ask whether the observed range of height values within communities is narrower or wider than expected, given the observed species richness.  To do this, for each community we need to compare the observed range value to a distribution of range values generated by randomly drawing species from the regional pool (i.e. from the entire dataset).

Following Cornwell et al. (2006), we will generate null distributions for each level of observed species richness in our dataset.

```{r}
SR=function(x){#creating a function to calculate species richness
  return(length(x[x!=0]))
}
obsSR=apply(commDat,1,SR)
sampleSR=as.numeric(levels(as.factor(obsSR)))#these are the levels of species richness for which we have to generate random communities

rndSample=list()#this is the first time we've encountered a "list"; this is a way of storing multiple matrices within the same (list) object
for (i in sampleSR){#going to create random communities for each level of observed species richness
  rndSample[[i]]=matrix(rep(0,ncol(commDat)*99),nrow=99,ncol=ncol(commDat))#creating a matrix of zeros that we will fill in row by row as we randomly sample
  colnames(rndSample[[i]])=colnames(commDat)
  for (j in 1:99){#doing this 99 times for each levels of species richness
    sample.ij=sample(colnames(commDat),i)#randomly samply i species
    rndSample[[i]][j,match(sample.ij,colnames(rndSample[[i]]))]=1#changing the values of the randomly sampled species to 1 in row j
  }
}
```

Now we will apply our rnge() function to the random data.

```{r}
rndHeightRnge=vector()
for (i in sampleSR){
  rndHeightRnge=cbind(rndHeightRnge,apply(rndSample[[i]],1,rnge,Height))
}
colnames(rndHeightRnge)=sampleSR
head(rndHeightRnge)
```

Now we have a matrix where each cell is a random estimate of height range for the same species richness in each column; that species richness is given by the column name.

Now let's compare our observed richness values to the random expectations.

```{r}
HeightSES=vector()
for (i in 1:length(HeightRnge)){
  rndDat=rndHeightRnge[,colnames(rndHeightRnge)==obsSR[i]]
  ses=(HeightRnge[i]-mean(rndDat,na.rm=T))/sd(rndDat,na.rm=T)#calculating the standardized effect size
  pVal=2*pnorm(-abs(ses))#calculating the P-value
  HeightSES=rbind(HeightSES,c(ses,pVal))
}
colnames(HeightSES)=c("SES","P")
rownames(HeightSES)=rownames(commDat)
HeightSES=as.data.frame(HeightSES)
hist(HeightSES$SES)
```

We can see that communities tend toward GREATER ranges of height than expecte by chance.  What does this suggest about environmental filtering via height?

Now let's see if filtering via height varies as a function of environment.

```{r}
envDat=read.csv('U:/LOCKED/grassland_data/environmental.csv',row.names=1)
cor.test(envDat$elev,HeightSES$SES)
cor.test(envDat$BD,HeightSES$SES)
```

It appears that SES of Height range is negatively correlated with elevation.  Let's plot it, with communities that have significantly higher or lower SES values than expected as solid circles, and non-significant values as open circles.

```{r}
plot(envDat$elev,HeightSES$SES,col=NA,xlab="Elevation (m)",ylab="Height Range SES (std.dev.)")
points(envDat$elev[HeightSES$P<0.05],HeightSES$SES[HeightSES$P<0.05],pch=19)
points(envDat$elev[HeightSES$P>0.05],HeightSES$SES[HeightSES$P>0.05])
```

We can see that the few communities with significantly greater ranges than expected tended to occur in relatively low elevation sites.  What might we conclude from this?